name: Deploy with Validation

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ” Validate HTML
        uses: Cyb3r-Jak3/html5validator-action@v7.2.0
        with:
          root: .
          
      - name: âœ… Validation passed
        run: echo "Code validation successful"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate  # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: ðŸ” Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          
      - name: ðŸš€ Deploy to server
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e
            
            cd $DEPLOY_PATH
            
            echo "ðŸ“¥ Pulling latest changes from origin..."
            git pull origin main
            
            echo "ðŸ”„ Git status:"
            git status
            
            echo "ðŸ“Š Latest commit:"
            git log -1 --oneline
            
            # ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾: Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            # sudo systemctl reload nginx
            
            echo "âœ… Deployment completed successfully at $(date '+%Y-%m-%d %H:%M:%S')"
          ENDSSH
          
      - name: ðŸŽ‰ Success notification
        run: |
          echo "::notice::âœ… Successfully deployed to https://striker.su"
          echo "ðŸ”— Live site: https://striker.su"
          echo "ðŸ“¦ Commit: ${{ github.sha }}"
